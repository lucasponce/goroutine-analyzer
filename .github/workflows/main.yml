name: build

on:
  push:
    branches:
      - main
      - release-v*
  workflow_dispatch:

env:
  gh_ci_key: ${{ secrets.GH_CI_KEY }}

jobs:
  build-linux-installer:
    name: Build Installer on Linux
    runs-on: ubuntu-latest
    steps:

# SETUP BUILD ENVIRONMENT
    - id: checkout-code
      name: Checkout code
      uses: actions/checkout@v3

    - id: setup-jdk
      name: Setup JDK
      uses: actions/setup-java@v2
      with:
        java-version: 17
        distribution: temurin

    - name: Install Go
      uses: actions/setup-go@v3
      with:
        go-version: '1.19.x'

    - name: Install Ziti CI
      uses: netfoundry/ziti-ci@v1

# BUILD FOR DISTRIBUTION
    - id: build
      name: Build distribution
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ziti_ci_gpg_key: ${{ secrets.ZITI_CI_GPG_KEY }}
        ziti_ci_gpg_key_id: ${{ secrets.ZITI_CI_GPG_KEY_ID }}
      run: |
        $(go env GOPATH)/bin/ziti-ci configure-git
        ./gradlew -v
        ./gradlew build
        ./gradlew copyDeps
        jpackage --verbose --app-version $($(go env GOPATH)/bin/ziti-ci -q get-next-version) "@jpackage.cfg" "@jpackage-linux.cfg"
        $(go env GOPATH)/bin/ziti-ci tag -v -f version
        gh release create $($(go env GOPATH)/bin/ziti-ci -q get-current-version) build/distributions/*
